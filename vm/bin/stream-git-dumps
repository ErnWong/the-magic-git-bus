#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

inotifywait --monitor --event close_write --event create --event move --event delete --recursive "$(git rev-parse --show-toplevel)/.git" | {
    last_update_ms=0
    while read -r line
    do
        # Don't accumulate events - always drain it all out
        while read -r -t 0 line
        do
            # Why isn't it returning failure?
            if [[ -z "$line" ]]
            then
                break
            fi
            line=""
        done
        "$SCRIPT_DIR/dump-git.sh" | jq '{ type: "git-dump", dump: . }' | "$SCRIPT_DIR/send-to-host.sh"
    done
}
